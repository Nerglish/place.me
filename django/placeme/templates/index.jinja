<!DOCTYPE html>
<html>
<head>
<script type="text/javascript" src="{{ STATIC_URL }}/jquery-1.7.2.min.js"></script>
<script type="text/javascript">
var hotel_pins = [];
var yelp_api = {};
var hotels = {};

$(function () {
//    var queries = [
//        {loc: 'seattle', term: 'hotels', hotels, 'seattle'},
//        {loc: 'seattle', term: 'hotels', hotels, 'seattle'},
//        {loc: 'seattle', term: 'hotels', hotels, 'seattle'},
//        {loc: 'seattle', term: 'hotels', hotels, 'seattle'}
//    ];

    //for (
    loadAPIData('seattle', 'hotels', hotels, 'rawr');
});

function loadAPIData(loc, term, root, key) {
    $.ajax({
        url: "/api/",
        data: { 'location': loc, 'term': term },
        success: function(result) {
            if (key in root) {
                root[key].businesses.concat(result.businesses);
            } else {
                root[key] = result;
            }
        }
    });
}

function yelpToCoordList(yelp_result) {
    var ret_list = [];
    for (var i = 0; i < yelp_result.businesses.length; i++) {
        place = yelp_result.businesses[i];
        coords = place.location.coordinate;
        ret_list.push(new google.maps.LatLng(coords.latitude, coords.longitude));
    }
    return ret_list;
}

function loadFullHotelCoordList() {
    var full_list = [];
    for (var key in hotels) {
        if (key) 
            full_list = full_list.concat(yelpToCoordList(hotels[key]));
    }
    hotels.full_list = full_list;
}

function clearHotelPins() {
    for (var i in hotel_pins) {
        hotel_pins[i].setMap(null);
    }
    hotel_pins = [];
}

function toggleAllHotels() {
    if (hotel_pins.length > 0) {
        clearHotelPins();
    } else {
        for (var i in hotels.full_list) {
            var pt = hotels.full_list[i];
            hotel_pins.push(new google.maps.Marker({
                position: pt, 
                map: map
            }));
        }
    }
}

$(loadFullHotelCoordList);


</script>


<!-- AUTOGENERATED -->
<script src="{{ STATIC_URL }}/api/ballard_seattle-hotels.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}/api/downtown_seattle-hotels.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}/api/family.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}/api/fremont_seattle-hotels.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}/api/gay.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}/api/hipster.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}/api/seattle-hotels.js" type="text/javascript"></script>
<!-- AUTOGENERATED -->

<link href="{{ STATIC_URL }}/css/bootstrap.css" rel="stylesheet">
<style type="text/css">
  html { height: 100% }
  body { height: 100%; margin: 0; padding: 0 }
  #map_canvas { margin-top: 10px; height: 500px; width: 800px; }
</style>
<script type="text/javascript"
  src="http://maps.googleapis.com/maps/api/js?key=AIzaSyD8Wt7InUYu7ZWF0uL4qh7eJdO-cGNs3nI&sensor=false&libraries=visualization">
</script>
<script type="text/javascript">
	var geocoder;
	var map;
	var currentHeatmap = null;
	var heatmaps = {};
	function initialize() {
		geocoder = new google.maps.Geocoder();
		//var latlng = new google.maps.LatLng(37.774546, -122.433523); // SF for taxiData
		var latlng = new google.maps.LatLng(47.6062095, -122.3320708); // Seattle
		var myOptions = {
			zoom : 11,
			center : latlng,
			mapTypeId : google.maps.MapTypeId.ROADMAP
		}
		map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);

		//pointArray = new google.maps.MVCArray(taxiData);
		for (key in yelp_api) {
			var data = yelpToCoordList(yelp_api[key]);
			var pointArray = new google.maps.MVCArray(data);
			
			heatmap = new google.maps.visualization.HeatmapLayer({
				data : pointArray
			});
	
			//heatmap.setMap(map);
			heatmap.setOptions({radius: 20, opacity: 0.5});
			heatmaps[key] = heatmap;
		}
		
		console.log(heatmaps);
	}
	function activateYelpHeatmap(key) {
		heatmap = heatmaps[key];
		if (heatmap == currentHeatmap) {
			deactivateYelpHeatmap();
			return;
		}
		deactivateYelpHeatmap();
		currentHeatmap = heatmap;
		currentHeatmap.setMap(map);
	}
	function deactivateYelpHeatmap() {
		if (currentHeatmap) {
			currentHeatmap.setMap(null);
			currentHeatmap = null;
		}
	}

	function toggleHeatmap() {
		heatmap.setMap(heatmap.getMap() ? null : map);
	}
	
	function changeGradient() {
        var gradient = [
          'rgba(0, 255, 255, 0)',
          'rgba(0, 255, 255, 1)',
          'rgba(0, 191, 255, 1)',
          'rgba(0, 127, 255, 1)',
          'rgba(0, 63, 255, 1)',
          'rgba(0, 0, 255, 1)',
          'rgba(0, 0, 223, 1)',
          'rgba(0, 0, 191, 1)',
          'rgba(0, 0, 159, 1)',
          'rgba(0, 0, 127, 1)',
          'rgba(63, 0, 91, 1)',
          'rgba(127, 0, 63, 1)',
          'rgba(191, 0, 31, 1)',
          'rgba(255, 0, 0, 1)'
        ]
        heatmap.setOptions({
            gradient: heatmap.get('gradient') ? null : gradient
        });
    }

    function changeRadius() {
        heatmap.setOptions({radius: heatmap.get('radius') ? null : 20});
    }

    function changeOpacity() {
        heatmap.setOptions({opacity: heatmap.get('opacity') ? null : 0.2});
    }

	function codeAddress() {
		var address = document.getElementById("address").value;
		geocoder.geocode({
			'address' : address
		}, function(results, status) {
			if (status == google.maps.GeocoderStatus.OK) {
				console.log(results[0].geometry.location);
				map.setCenter(results[0].geometry.location);
				var marker = new google.maps.Marker({
					map : map,
					position : results[0].geometry.location
				});
			} else {
				console.log("Geocode was not successful for the following reason: " + status);
			}
		});
	}
</script>
</head>
<body onload="initialize()">
  <div>
    <input id="address" type="textbox" value="Seattle, WA">
    <input class="btn" type="button" value="Lookup" onclick="codeAddress()">
    <input class="btn" type="button" value="Hotel Show" onclick="toggleAllHotels()">
  </div>
  <div>
  	<button class="btn" onclick="activateYelpHeatmap('family')">Show Family Heatmap</button>
  	<button class="btn" onclick="activateYelpHeatmap('hipster')">Show Hipster Heatmap</button>
  	<button class="btn" onclick="activateYelpHeatmap('gay')">Show Gay Heatmap</button>
  </div>
<div id="map_canvas"></div>
</body>
</html>
